import requests
from bs4 import BeautifulSoup
import wx
import wx.html2

# Set the URL to start with
START_URL = 'https://www.piaotia.com/html/6/6022/3885105.html'

def fetch_and_clean_content(url):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
    }
    response = requests.get(url, headers=headers)
    soup = BeautifulSoup(response.content, 'html.parser')
    
    # Remove unwanted elements
    for ad in soup.select('ads, .ad, .advertisement'):
        ad.decompose()
    
    content = soup.get_text()

    # Find and strip content before "返回书页" and after "返回顶部"
    
    if content:
        start_index = content.find("返回书页")
        end_index = content.find("返回顶部")
        if start_index != -1 and end_index != -1 and start_index < end_index:
            content = content[start_index + len("返回书页"):end_index].strip()
    else:
        content = "Content not found"
    
    next_page = soup.find('a', text='下一章')
    next_page_url = next_page['href'] if next_page else None
    next_page_url = 'https://www.piaotia.com/html/6/6022/' + next_page_url
    print (next_page_url)
    
    return content, next_page_url

class HtmlWindow(wx.Frame):
    def __init__(self, parent, title):
        super(HtmlWindow, self).__init__(parent, title=title, size=(1600, 1000))

        self.browser = wx.html2.WebView.New(self)
        self.next_page_url = None

        self.Bind(wx.EVT_BUTTON, self.on_next_page, id=wx.ID_ANY)

        self.sizer = wx.BoxSizer(wx.VERTICAL)
        self.sizer.Add(self.browser, 1, wx.EXPAND)

        self.next_button = wx.Button(self, label="Next Page")
        self.sizer.Add(self.next_button, 0, wx.ALIGN_CENTER | wx.ALL, 10)

        self.SetSizer(self.sizer)
        self.Layout()

        self.load_page(START_URL)

    def load_page(self, url):
        content, next_page_url = fetch_and_clean_content(url)
        self.next_page_url = next_page_url
        html_content = f"""
        <html>
        <head>
            <style>
                body {{
                    font-family: Arial, sans-serif;
                    background-color: #121212;
                    color: #ffffff;
                    font-size: 2.2em;
                    line-height: 1.6;
                }}
                #content {{
                    white-space: pre-wrap;
                }}
                button {{
                    display: block;
                    margin: 20px auto;
                    padding: 10px 20px;
                    font-size: 1em;
                    background-color: #1E90FF;
                    color: #ffffff;
                    border: none;
                    cursor: pointer;
                }}
                button:hover {{
                    background-color: #4169E1;
                }}
            </style>
        </head>
        <body>
            <div id="content">{content}</div>
        </body>
        </html>
        """
        self.browser.SetPage(html_content, "")

    def on_next_page(self, event):
        if self.next_page_url:
            self.load_page(self.next_page_url)

if __name__ == '__main__':
    app = wx.App(False)
    frame = HtmlWindow(None, "Reading Mode")
    frame.Show()
    app.MainLoop()